<%- layout("/layouts/boilerplate") -%>

<style>
  .appointment-container {
    max-width: 80%;
    margin: 2rem auto;
    padding: 0 1rem;
    color: #e0e0e0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  h1 {
    text-align: center;
    color: #9c27b0;
    margin-bottom: 2rem;
    font-weight: 700;
    font-size: 2rem;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(156, 39, 176, 0.1);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 6px 18px rgba(123, 31, 162, 0.3);
  }
  thead {
    background-color: #7b1fa2;
  }
  thead th {
    padding: 12px 15px;
    text-align: left;
    font-weight: 700;
    color: white;
    font-size: 1rem;
  }
  tbody tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    cursor: default;
    transition: background-color 0.2s ease;
  }
  tbody tr:hover {
    background-color: rgba(123, 31, 162, 0.2);
  }
  tbody td {
    padding: 12px 15px;
    font-size: 0.95rem;
    vertical-align: middle;
  }

  .status-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 15px;
    font-weight: 700;
    font-size: 0.85rem;
    user-select: none;
    color: white;
    min-width: 90px;
    text-align: center;
    text-transform: capitalize;
  }
  .status-pending { background: #fbc02d; color: #222; }
  .status-approved { background: #4caf50; }
  .status-rejected { background: #f44336; }
  .status-cancelled { background: #9e9e9e; }
  .status-completed { background: #2196f3; }

  button.action-btn {
    background-color: #9c27b0;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    font-size: 0.85rem;
    margin: 0 3px;
    transition: background-color 0.3s ease;
  }
  button.action-btn:hover {
    background-color: #7b1fa2;
  }
  button.action-btn.danger {
    background-color: #f44336;
  }
  button.action-btn.danger:hover {
    background-color: #d32f2f;
  }

  button.action-btn[disabled] {
    background-color: #555 !important;
    cursor: not-allowed;
    opacity: 0.6;
  }

  /* Responsive tweak: table horizontal scroll on small screens */
  @media (max-width: 768px) {
    .appointment-container {
      padding: 0 0.5rem;
    }
    table {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
  }

  .no-appointments {
    text-align: center;
    font-size: 1.3rem;
    color: #bdbdbd;
    margin-top: 3rem;
  }
</style>

<section class="appointment-container" aria-label="Appointments List">
  <h1>Your Appointments</h1>

  <% if (!appointments || appointments.length === 0) { %>
    <p class="no-appointments" role="alert">No appointments found.</p>
  <% } else { %>
    <table role="table">
      <thead>
        <tr>
          <% if (user.role === "user") { %>
            <th scope="col">Lawyer</th>
            <th scope="col">Specialization</th>
          <% } else if (user.role === "lawyer") { %>
            <th scope="col">Client</th>
            <th scope="col">Email</th>
          <% } else { %>
            <th scope="col">Client</th>
            <th scope="col">Lawyer</th>
          <% } %>
          <th scope="col">Date</th>
          <th scope="col">Time Slot(s)</th>
          <th scope="col">Appointment Card</th>
          <th scope="col">Status</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% appointments.forEach(appointment => { %>
          <tr>
            <% if (user.role === "user") { %>
              <td><%= appointment.lawyer?.username || 'N/A' %> <span><a href="/lawyers/<%= appointment.lawyer?._id %>" class="badge bg-info text-dark">View</a></span></td>
              <td><%= appointment.lawyer?.lawyerProfile?.specialization || 'N/A' %></td>
            <% } else if (user.role === "lawyer") { %>
              <td><%= appointment.client?.username || 'N/A' %></td>
              <td><%= appointment.client?.email || 'N/A' %></td>
            <% } else { %>
              <td><%= appointment.client?.username || 'N/A' %></td>
              <td><%= appointment.lawyer?.username || 'N/A' %></td>
            <% } %>
            <td><%= appointment.date ? appointment.date.toDateString() : 'N/A' %></td>
            <td>
              <% if (Array.isArray(appointment.timeSlot)) { %>
                <%= appointment.timeSlot.join(", ") %>
              <% } else { %>
                <%= appointment.timeSlot || 'N/A' %>
              <% } %>
            </td>
            <!-- view button to view appointment card -->
             <td>
              <% if (appointment.appointmentCard) { %>
                <button
                  class="action-btn"
                  aria-label="View appointment card"
                  title="View appointment card"
                  onclick="window.location.href='/api/appointment/<%= appointment._id %>/card/view'">View</button>
              <% } else { %>
                <span style="color:#bdbdbd; font-size:0.9rem;">No card generated yet</span>
              <% } %>
            </td>
            <!-- status -->
            <td>
              <span class="status-badge status-<%= appointment.status %>" aria-label="Status: <%= appointment.status %>">
                <%= appointment.status %>
              </span>
            </td>
            <!-- actions -->
            <td>
              <% if (user.role === "user") { %>
                <% if (["pending", "approved"].includes(appointment.status)) { %>
                  <button
                    class="action-btn"
                    aria-label="Chat with lawyer"
                    title="Chat with lawyer"
                    onclick="window.location.href='/chat/room/<%= appointment._id %>'">Chat</button>
                  <button
                    class="action-btn danger"
                    aria-label="Cancel appointment"
                    title="Cancel this appointment"
                    onclick="cancelAppointment('<%= appointment._id %>')">Cancel</button>
                <% } else { %>
                  <span style="color:#bdbdbd; font-size:0.9rem;">No actions available</span>
                <% } %>
              <% } else if (user.role === "lawyer") { %>
                <% if (appointment.status === "pending") { %>
                  <button
                    class="action-btn"
                    aria-label="Chat with client"
                    title="Chat with client"
                    onclick="window.location.href='/chat/room/<%= appointment._id %>'">Chat</button>
                  <button
                    class="action-btn"
                    aria-label="Approve appointment"
                    title="Approve this appointment"
                    onclick="updateStatus('<%= appointment._id %>', 'approved')">Approve</button>
                  <button
                    class="action-btn danger"
                    aria-label="Reject appointment"
                    title="Reject this appointment"
                    onclick="updateStatus('<%= appointment._id %>', 'rejected')">Reject</button>
                  <button
                    class="action-btn danger"
                    aria-label="Cancel appointment"
                    title="Cancel this appointment"
                    onclick="updateStatus('<%= appointment._id %>', 'cancelled')">Cancel</button>
                <% } else if (appointment.status === "approved") { %>
                  <button
                    class="action-btn"
                    aria-label="Chat with client"
                    title="Chat with client"
                    onclick="window.location.href='/chat/room/<%= appointment._id %>'">Chat</button>
                  <button
                    class="action-btn danger"
                    aria-label="Cancel appointment"
                    title="Cancel this appointment"
                    onclick="updateStatus('<%= appointment._id %>', 'cancelled')">Cancel</button>
                  <button
                    class="action-btn"
                    aria-label="Mark appointment as completed"
                    title="Mark this appointment as completed"
                    onclick="updateStatus('<%= appointment._id %>', 'completed')">Complete</button>
                <% } else if (["rejected", "cancelled", "completed"].includes(appointment.status)) { %>
                  <button
                    class="action-btn danger"
                    aria-label="Cancel appointment"
                    title="Cancel this appointment"
                    onclick="cancelAppointment('<%= appointment._id %>')">Cancel</button>
                <% } else { %>
                  <span style="color:#bdbdbd; font-size:0.9rem;">No actions available</span>
                <% } %>
              <% } else { %>
                <span style="color:#bdbdbd; font-size:0.9rem;">No actions available</span>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</section>

<div id="tab-bookings" class="tab-content" style="display:none">
  <div class="card-alt">
    <h4><%= user.role === 'lawyer' ? 'Client Appointments' : 'My Appointments' %></h4>

    <% if (appointments && appointments.length > 0) { %>
      <% appointments.forEach(appt => { %>
        <div class="card-alt" style="margin-top:1rem">
          <h5>Appointment with <%= user.role === 'lawyer' ? appt.client.username : appt.lawyer.username %></h5>
          <p>Date: <%= new Date(appt.date).toLocaleDateString() %></p>
          <p>Time: <%= appt.timeSlot.join(", ") %></p>
          <p>Card ID: <%= appt.appointmentCard?.cardId %></p>

          <% if (appt.appointmentCard) { %>
            <img src="<%= appt.appointmentCard.qrCode %>" alt="QR Code" style="width:120px;height:120px"/>

            <div style="margin-top:0.8rem">
              <a href="/api/appointment/<%= appt._id %>/card/download" 
                 class="btn btn-outline-primary">Download Card (PDF)</a>
            </div>
          <% } else { %>
            <small class="muted">No appointment card generated yet</small>
          <% } %>
        </div>
      <% }) %>
    <% } else { %>
      <p class="muted">No appointments found.</p>
    <% } %>
  </div>
</div>


<script>
  async function updateStatus(appointmentId, status) {
    if (!confirm(`Are you sure you want to mark this appointment as "${status}"?`)) return;
    try {
      const res = await fetch('/api/appointment/status', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ appointmentId, status }),
      });
      const data = await res.json();
      if (res.ok) {
        alert('Appointment status updated successfully.');
        location.reload();
      } else {
        alert(data.msg || 'Failed to update appointment status.');
      }
    } catch (err) {
      alert('Error updating appointment status, please try again.');
      console.error(err);
    }
  }

  async function cancelAppointment(appointmentId) {
    if (!confirm('Are you sure you want to cancel this appointment?')) return;
    try {
      const res = await fetch(`/api/appointment/${appointmentId}`, {
        method: 'DELETE',
      });
      const data = await res.json();
      if (res.ok) {
        alert('Appointment cancelled successfully.');
        location.reload();
      } else {
        alert(data.msg || 'Failed to cancel appointment.');
      }
    } catch (err) {
      alert('Error cancelling appointment, please try again.');
      console.error(err);
    }
  }
</script>